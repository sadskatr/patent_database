{% extends "base.html" %}
{% block title %}{{ tool_name }}{% endblock %}

{% block content %}
<div class="container-fluid px-4 compact">
    <h2>{{ tool_name }}</h2>
    
    <!-- Search Parameters Form -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0 cursor-pointer" id="searchParametersHeader">Search Parameters <i class="bi bi-chevron-up float-end toggle-icon"></i></h5>
        </div>
        <div class="card-body compact-form">
            <form id="searchForm">-
                <!-- Search Type Selection -->
                <div class="row mb-2">
                    <div class="col-md-12">
                        <label for="searchType" class="form-label">Search Type</label>
                        <select class="form-select" id="searchType">
                            <option value="simple">Simple</option>
                            <option value="boolean">Boolean</option>
                            <option value="field_specific">Field Specific</option>
                        </select>
                        <small class="form-text text-muted search-type-help d-none" id="boolean-help">
                            Combine multiple search terms with AND, OR, NOT operators
                        </small>
                        <small class="form-text text-muted search-type-help d-none" id="field_specific-help">
                            Search in a specific field of the patent data
                        </small>
                    </div>
                </div>
                
                <!-- Search Parameters (dynamically shown/hidden based on search type) -->
                <div id="searchParamsContainer">
                    <!-- Simple Search -->
                    <div class="search-params" id="simple-params">
                        <div class="row mb-2">
                            <div class="col-md-12">
                                <input type="text" class="form-control" id="simpleSearchTerm" placeholder="Enter search term">
                                <small class="form-text text-muted">Search across patent title and text</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Boolean Search -->
                    <div class="search-params d-none" id="boolean-params">
                        <div id="booleanTerms">
                            <!-- First term (no operator) -->
                            <div class="boolean-term first-term row mb-2">
                                <div class="col-md-5">
                                    <label class="form-label small">Field</label>
                                    <select class="form-select boolean-field">
                                        <!-- Will be populated by JavaScript -->
                                    </select>
                                    <small class="form-text text-muted field-description"></small>
                                </div>
                                <div class="col-md-7">
                                    <label class="form-label small">Value</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control boolean-value" placeholder="Enter search value">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Additional terms (with operators) will be added here dynamically -->
                        </div>
                        <div class="row mt-2 mb-2">
                            <div class="col">
                        <button type="button" class="btn btn-outline-primary btn-sm" id="addBooleanTerm">
                            <i class="bi bi-plus"></i> Add Term
                        </button>
                    </div>
                        </div>
                    </div>
                    
                    <!-- Field-Specific Search -->
                    <div class="search-params d-none" id="field_specific-params">
                        <div class="row mb-2">
                            <div class="col-md-6">
                                <label for="fieldSpecificField" class="form-label">Field</label>
                                <select class="form-select" id="fieldSpecificField">
                                    {% for field in valid_fields.field_specific %}
                                    <option value="{{ field }}">{{ field_display_names.get(field, field) }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="fieldSpecificValue" class="form-label">Value</label>
                                <input type="text" class="form-control" id="fieldSpecificValue" placeholder="Enter exact value">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Common Parameters -->
                <div class="row mb-2 mt-2">
                    <div class="col-md-4">
                        <label for="resultsLimit" class="form-label">Results Per Page</label>
                        <select class="form-select" id="resultsLimit">
                            <option value="10">10</option>
                            <option value="25">25</option>
                            <option value="50" selected>50</option>
                            <option value="100">100 (maximum)</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="applicationType" class="form-label">Application Type</label>
                        <select class="form-select" id="applicationType">
                            <option value="Utility" selected>Utility</option>
                            <option value="Design">Design</option>
                            <option value="Provisional">Provisional</option>
                            <option value="PCT">PCT</option>
                            <option value="All">All Types</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="sortField" class="form-label">Sort By</label>
                        <div class="input-group">
                            <select class="form-select" id="sortField">
                                {% for field in valid_fields.sorting %}
                                <option value="{{ field }}">{{ field_display_names.get(field, field) }}</option>
                                {% endfor %}
                            </select>
                            <select class="form-select" id="sortOrder">
                                <option value="desc">Descending</option>
                                <option value="asc">Ascending</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Common Date Range Filter -->
                <div class="row mb-2">
                    <div class="col-md-12">
                        <div class="mb-2">
                            <label class="form-label">Filing Date Range</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="dateFrom" class="form-label">From Date</label>
                        <input type="date" class="form-control" id="dateFrom" required>
                    </div>
                    <div class="col-md-6">
                        <label for="dateTo" class="form-label">To Date</label>
                        <input type="date" class="form-control" id="dateTo" required>
                    </div>
                    <div class="col-md-12 mt-1">
                        <div class="btn-group btn-group-sm" role="group" aria-label="Date range shortcuts">
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="oneYearBtn" onclick="setDateRange(1)">1yr</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="twoYearBtn" onclick="setDateRange(2)">2yr</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="threeYearBtn" onclick="setDateRange(3)">3yr</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="fiveYearBtn" onclick="setDateRange(5)">5yr</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="tenYearBtn" onclick="setDateRange(10)">10yr</button>
                        </div>
                        <small class="text-muted ms-2">Quick date range</small>
                    </div>
                </div>
                
                <!-- Preview Query Section -->
                <div class="row mb-2">
                    <div class="col-md-12">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="showQueryPreview">
                            <label class="form-check-label" for="showQueryPreview">
                                Show API Debug Info
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="showJsonResponse">
                            <label class="form-check-label" for="showJsonResponse">
                                API Response JSON
                            </label>
                        </div>
                    </div>
                </div>
                
                <div id="queryPreviewContainer" class="d-none">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">API Request Preview</h6>
                        <button id="clearDebugInfoBtn" class="btn btn-sm btn-outline-secondary">Clear</button>
                    </div>
                    <div class="alert alert-secondary">
                        <div class="mb-2">
                            <strong>API Endpoint:</strong> <span id="endpointUrl"></span>
                        </div>
                        <div class="mb-2">
                            <strong>Request Payload:</strong>
                        <pre id="queryPreview" class="mb-0 bg-light p-2 rounded" style="font-size: 0.8rem;"></pre>
                    </div>
                    </div>
                    <div id="debugOutput" class="alert alert-dark" style="max-height: 300px; overflow-y: auto; display: none;">
                        <!-- Debug output will be inserted here -->
                    </div>
                </div>
                
                <!-- Search Button -->
                <div class="row mb-2">
                    <div class="col-md-12">
                        <button type="submit" class="btn btn-primary" id="searchBtn">Search</button>
                        <button type="button" class="btn btn-outline-secondary" id="resetBtn">Reset</button>
                    </div>
                </div>
                
                <!-- Replace the Saved Searches section with JSON Output -->
                <div class="row mb-2" id="jsonResponseContainer">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center py-1">
                                <h6 class="mb-0">API Response JSON</h6>
                                <button class="btn btn-sm btn-outline-secondary" id="clearJsonBtn">
                                    <i class="bi bi-x"></i> Clear
                                </button>
                            </div>
                            <div class="card-body p-0">
                                <pre id="jsonOutput" class="m-0 p-2" style="max-height: 120px; overflow-y: auto; font-size: 0.75rem; background-color: #f8f9fa;">No search performed yet</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Results Section -->
    <div id="resultsContainer" class="d-none">
        <div class="card">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center py-2">
                <div class="d-flex align-items-center">
                    <h5 class="mb-0 me-2">Search Results</h5>
                </div>
                <div>
                    <button id="tableViewBtn" class="btn btn-light btn-sm active me-2">
                        <i class="bi bi-table"></i> Table View
                    </button>
                    <button id="cardViewBtn" class="btn btn-light btn-sm me-2">
                        <i class="bi bi-card-list"></i> Card View
                    </button>
                    <button id="exportExcelBtn" class="btn btn-light btn-sm">
                        <i class="bi bi-file-earmark-excel"></i> Export to Excel
                    </button>
                </div>
            </div>
            <div class="card-body compact-form">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div id="resultsStats" class="alert alert-info py-1 mb-0">
                        <span id="resultCount">0</span> results found
                    </div>
                    <div class="d-flex">
                        <div class="input-group input-group-sm me-2" style="width: 250px;">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" id="tableSearchFilter" placeholder="Filter results...">
                        </div>
                    </div>
                </div>
                
                <!-- Table Results View -->
                <div id="tableResultsView">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped table-sm align-middle" id="resultsTable">
                            <thead class="table-light">
                                <tr>
                                    <th class="sortable filterable" data-sort="title" data-field="title">Title <i class="bi bi-arrow-down-up sort-icon"></i><i class="bi bi-funnel filter-icon"></i><span class="filter-badge d-none"></span></th>
                                    <th class="sortable filterable" data-sort="filingDate" data-field="filingDate">Filed <i class="bi bi-arrow-down-up sort-icon"></i><i class="bi bi-funnel filter-icon"></i><span class="filter-badge d-none"></span></th>
                                    <th class="sortable filterable" data-sort="applicant" data-field="applicant">Applicant <i class="bi bi-arrow-down-up sort-icon"></i><i class="bi bi-funnel filter-icon"></i><span class="filter-badge d-none"></span></th>
                                    <th class="sortable filterable" data-sort="publicationNumber" data-field="publicationNumber">Pub # <i class="bi bi-arrow-down-up sort-icon"></i><i class="bi bi-funnel filter-icon"></i><span class="filter-badge d-none"></span></th>
                                    <th class="sortable filterable" data-sort="status" data-field="status">Status <i class="bi bi-arrow-down-up sort-icon"></i><i class="bi bi-funnel filter-icon"></i><span class="filter-badge d-none"></span></th>
                                    <th class="sortable filterable" data-sort="type" data-field="type">Type <i class="bi bi-arrow-down-up sort-icon"></i><i class="bi bi-funnel filter-icon"></i><span class="filter-badge d-none"></span></th>
                                    <th class="sortable filterable" data-sort="customerNumber" data-field="customerNumber">Customer # <i class="bi bi-arrow-down-up sort-icon"></i><i class="bi bi-funnel filter-icon"></i><span class="filter-badge d-none"></span></th>
                                    <th class="sortable filterable" data-sort="examiner" data-field="examiner">Examiner <i class="bi bi-arrow-down-up sort-icon"></i><i class="bi bi-funnel filter-icon"></i><span class="filter-badge d-none"></span></th>
                                    <th class="sortable filterable" data-sort="inventors" data-field="inventors">Inventors <i class="bi bi-arrow-down-up sort-icon"></i><i class="bi bi-funnel filter-icon"></i><span class="filter-badge d-none"></span></th>
                                    <th class="sortable filterable" data-sort="applicationNumber" data-field="applicationNumber">App # <i class="bi bi-arrow-down-up sort-icon"></i><i class="bi bi-funnel filter-icon"></i><span class="filter-badge d-none"></span></th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody">
                                <!-- Results will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Card Results View (original version) -->
                <div id="cardResultsView" class="d-none">
                    <div id="resultsList" class="list-group">
                        <!-- Results will be inserted here as before -->
                    </div>
                </div>
                
                <!-- Pagination -->
                <div class="d-flex justify-content-between align-items-center mt-2 mb-1">
                    <div>
                        <span id="paginationInfo">Showing 0-0 of 0</span>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-secondary" id="prevPageBtn" disabled>Previous</button>
                        <button type="button" class="btn btn-outline-secondary" id="nextPageBtn" disabled>Next</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Global variables
    let debugMode = true;
    let currentPage = 0;
    let pageSize = 50;
    let currentSearchResults = [];
    let totalResults = 0;
    // Store search field data from CSV
    let searchFields = [];

    // Initialize all event listeners and UI elements when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize controllers with original variable names and elements
        const searchTypeSelect = document.getElementById('searchType');
        const searchBtn = document.getElementById('searchBtn');
        const resetBtn = document.getElementById('resetBtn');
        const showQueryPreviewCheckbox = document.getElementById('showQueryPreview');
        const showJsonResponseCheckbox = document.getElementById('showJsonResponse');
        const queryPreviewContainer = document.getElementById('queryPreviewContainer');
        const queryExamplesPanel = document.getElementById('queryExamplesPanel');
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        const addBooleanTermBtn = document.getElementById('addBooleanTerm');
        const jsonResponseContainer = document.getElementById('jsonResponseContainer');
        const clearJsonBtn = document.getElementById('clearJsonBtn');
        
        // Load search fields data
        loadSearchFields();
        
        // Initialize form submission
        const searchForm = document.getElementById('searchForm');
        if (searchForm) {
            searchForm.addEventListener('submit', function(event) {
                event.preventDefault();
                performSearch();
            });
        }

        // Setup table sorting
        setupTableSorting();
        
        // Setup filtering
        setupTableFilter();
        
        // Setup view toggling
        setupViewToggle();
        
        // Setup column filtering
        setupColumnFiltering();
        
        // Setup collapsible search parameters
        setupCollapsibleCard();
        
        // Event listener for the JSON response toggle
        if (showJsonResponseCheckbox) {
            showJsonResponseCheckbox.addEventListener('change', function() {
                if (jsonResponseContainer) {
                    jsonResponseContainer.classList.toggle('d-none', !this.checked);
                }
            });
            
            // Initialize JSON container visibility based on checkbox state
            if (jsonResponseContainer) {
                jsonResponseContainer.classList.toggle('d-none', !showJsonResponseCheckbox.checked);
            }
        }
        
        // Reset button functionality
        if (resetBtn) {
            resetBtn.addEventListener('click', function() {
                // Reset all form fields
                document.getElementById('searchForm').reset();
                
                // Reset the boolean terms to just the first one
                const booleanTerms = document.getElementById('booleanTerms');
                const additionalTerms = booleanTerms.querySelectorAll('.boolean-term:not(.first-term)');
                additionalTerms.forEach(term => term.remove());
                
                // Clear any results
                document.getElementById('resultsList').innerHTML = '';
                document.getElementById('resultsContainer').classList.add('d-none');
                document.getElementById('jsonOutput').textContent = 'No search performed yet';
                
                // Reset pagination
                currentPage = 0;
                
                // Update UI if needed
                if (showQueryPreviewCheckbox.checked) {
                    updateQueryPreview();
                }
            });
        }

        // After the resetBtn handler, restore the other event handlers
        // UI elements for pagination
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const paginationInfo = document.getElementById('paginationInfo');
        const resultCount = document.getElementById('resultCount');
        const resultsList = document.getElementById('resultsList');

        // Boolean search event listeners
        if (addBooleanTermBtn) {
            addBooleanTermBtn.addEventListener('click', addBooleanTerm);
        }

        // Add event listener for boolean field selection to show descriptions
        document.addEventListener('change', function(e) {
            if (e.target && e.target.classList.contains('boolean-field')) {
                updateFieldDescription(e.target);
            }
        });

        // Date range shortcut function
        window.setDateRange = function(years) {
            const dateTo = document.getElementById('dateTo');
            const dateFrom = document.getElementById('dateFrom');
            
            // Set the "to" date to today
            const today = new Date();
            dateTo.value = today.toISOString().split('T')[0];
            
            // Set the "from" date to X years ago
            const fromDate = new Date();
            fromDate.setFullYear(today.getFullYear() - years);
            dateFrom.value = fromDate.toISOString().split('T')[0];
        };

        // Initialize search type change handler
        searchTypeSelect.addEventListener('change', function() {
            const searchType = this.value;
            
            // Hide all parameter containers and help text
            document.querySelectorAll('.search-params').forEach(el => el.classList.add('d-none'));
            document.querySelectorAll('.search-type-help').forEach(el => el.classList.add('d-none'));
            
            // Show the appropriate container and help text
            document.getElementById(`${searchType}-params`).classList.remove('d-none');
            document.getElementById(`${searchType}-help`).classList.remove('d-none');
            
            // Update query preview if enabled
            if (showQueryPreviewCheckbox.checked) {
                updateQueryPreview();
            }
        });

        // Clear JSON button
        if (clearJsonBtn) {
            clearJsonBtn.addEventListener('click', function() {
                document.getElementById('jsonOutput').textContent = 'No search performed yet';
            });
        }

        // Export to Excel button event listener
        if (exportExcelBtn) {
            exportExcelBtn.addEventListener('click', function() {
                // Get current search parameters
                const searchParams = getSearchParams();
                
                // Check if we need to add the patent_database prefix
                const apiPath = window.location.pathname.includes('/patent_database') ? 
                    '/patent_database/api/export-csv' : 
                    '/api/export-csv';
                
                console.log(`Exporting Excel from: ${apiPath}`);
                
                // Add format parameter for Excel
                searchParams.format = 'excel';
                
                // Send export request
                fetch(apiPath, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(searchParams)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.blob();
                })
                .then(blob => {
                    // Create a link to download the file
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = 'patent_search_results.xlsx';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                })
                .catch(error => {
                    console.error('Error exporting to Excel:', error);
                    alert('Error exporting to Excel: ' + error.message);
                });
            });
        }

        // Show/hide query preview container
        showQueryPreviewCheckbox.addEventListener('change', function() {
            queryPreviewContainer.classList.toggle('d-none', !this.checked);
            if (this.checked) {
                updateQueryPreview();
            }
        });

        // Add event listeners to update query preview when form fields change
        const formElements = [
            document.getElementById('searchType'),
            document.getElementById('simpleSearchTerm'),
            document.getElementById('fieldSpecificField'),
            document.getElementById('fieldSpecificValue'),
            document.getElementById('dateFrom'),
            document.getElementById('dateTo'),
            document.getElementById('resultsLimit'),
            document.getElementById('sortField'),
            document.getElementById('sortOrder')
        ];

        formElements.forEach(element => {
            if (element) {
                element.addEventListener('change', function() {
                    if (showQueryPreviewCheckbox.checked) {
                        updateQueryPreview();
                    }
                });

                // For text inputs, also listen for keyup events
                if (element.tagName === 'INPUT' && element.type === 'text') {
                    element.addEventListener('keyup', function() {
                        if (showQueryPreviewCheckbox.checked) {
                            updateQueryPreview();
                        }
                    });
                }
            }
        });

        // Listen for changes to boolean terms
        document.addEventListener('input', function(e) {
            if (e.target && (
                e.target.classList.contains('boolean-field') || 
                e.target.classList.contains('boolean-value') || 
                e.target.classList.contains('boolean-operator')
            )) {
                if (showQueryPreviewCheckbox.checked) {
                    updateQueryPreview();
                }
            }
        });

        // Add click handler for clearDebugInfoBtn
        const clearDebugInfoBtn = document.getElementById('clearDebugInfoBtn');
        if (clearDebugInfoBtn) {
            clearDebugInfoBtn.addEventListener('click', function() {
                document.getElementById('debugOutput').innerHTML = '';
                document.getElementById('debugOutput').style.display = 'none';
            });
        }

        // Add event listener for the details toggle to expand/collapse all patents
        const showDetailsToggle = document.getElementById('showDetailsToggle');
        if (showDetailsToggle) {
            showDetailsToggle.addEventListener('change', function() {
                // Update all patent details sections
                const detailsSections = document.querySelectorAll('.patent-details');
                const toggleButtons = document.querySelectorAll('.toggle-details-btn');
                
                detailsSections.forEach(section => {
                    section.classList.toggle('d-none', !this.checked);
                });
                
                toggleButtons.forEach(button => {
                    button.setAttribute('aria-expanded', this.checked);
                    button.querySelector('i').classList.toggle('bi-chevron-right', !this.checked);
                    button.querySelector('i').classList.toggle('bi-chevron-down', this.checked);
                });
            });
        }

        // Add some global styles with original spacing and typography
        const style = document.createElement('style');
        style.textContent = `
            body {
                font-size: 1rem;
            }
            .card {
                box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
                border: 1px solid rgba(0,0,0,0.125);
                border-radius: 0.25rem;
                margin-bottom: 1rem;
            }
            .card-header {
                padding: 0.75rem 1.25rem;
                border-bottom: 1px solid rgba(0,0,0,0.125);
            }
            .card-body {
                padding: 1.25rem;
            }
            .form-control, .form-select {
                padding: 0.375rem 0.75rem;
                border-radius: 0.25rem;
            }
            .form-label {
                margin-bottom: 0.5rem;
                font-weight: normal;
            }
            .list-group-item {
                padding: 0.75rem 1.25rem;
            }
            .boolean-term {
                margin-bottom: 1rem !important;
            }
            .mb-3 {
                margin-bottom: 1rem !important;
            }
            .mb-2 {
                margin-bottom: 0.5rem !important;
            }
            .mb-1 {
                margin-bottom: 0.25rem !important;
            }
            .mt-4 {
                margin-top: 1.5rem !important;
            }
            .mt-3 {
                margin-top: 1rem !important;
            }
            .mt-2 {
                margin-top: 0.5rem !important;
            }
            .alert {
                padding: 0.75rem 1.25rem;
                margin-bottom: 1rem;
            }
            .search-params {
                padding-top: 0.5rem;
                padding-bottom: 0.5rem;
            }
            .patent-title {
                font-size: 1.25rem;
                font-weight: 500;
            }
            .container-fluid {
                padding-left: 15px;
                padding-right: 15px;
            }
            .py-2 {
                padding-top: 0.5rem !important;
                padding-bottom: 0.5rem !important;
            }
        `;
        document.head.appendChild(style);
    });
    
    // Function to load search fields from CSV
    async function loadSearchFields() {
        try {
            console.log('Starting CSV loading process...');
            
            // Determine URL prefix based on path
            const urlPrefix = window.location.pathname.endsWith('/') ? '' : '/';
            
            // Define multiple paths to try
            const csvPath = urlPrefix + 'api/search-fields-csv';
            const directPath = urlPrefix + 'api/search-fields-csv-direct';
            const staticPath = urlPrefix + 'api/static-csv-content';
            const hardcodedPath = urlPrefix + 'api/direct-csv-data';
            
            console.log(`Trying primary CSV path: ${csvPath}`);

            // Try primary route first
            let primaryError = null;
            try {
                const response = await fetch(csvPath);
                console.log(`Primary CSV fetch status: ${response.status}`);
                
                if (!response.ok) {
                    primaryError = new Error(`Network response was not ok: ${response.status} ${response.statusText}`);
                    throw primaryError;
                }
                
                const csvText = await response.text();
                console.log(`Received CSV data (first 100 chars): ${csvText.substring(0, 100)}`);
                parseCSV(csvText);
                return; // Success, exit function
            } catch (error) {
                console.error('Error fetching CSV from primary path:', error);
                primaryError = error;
            }
            
            // Try direct route if primary fails
            let directError = null;
            console.log(`Trying direct CSV path: ${directPath}`);
            try {
                const directResponse = await fetch(directPath);
                console.log(`Direct CSV fetch status: ${directResponse.status}`);
                
                if (!directResponse.ok) {
                    directError = new Error(`Direct route failed: ${directResponse.status} ${directResponse.statusText}`);
                    throw directError;
                }
                
                const directCsvText = await directResponse.text();
                console.log(`Received direct CSV data (first 100 chars): ${directCsvText.substring(0, 100)}`);
                parseCSV(directCsvText);
                return; // Success, exit function
            } catch (error) {
                console.error('Error fetching CSV from direct path:', error);
                directError = error;
            }
            
            // Try static route if both previous fail
            let staticError = null;
            console.log(`Trying static CSV path: ${staticPath}`);
            try {
                const staticResponse = await fetch(staticPath);
                console.log(`Static CSV fetch status: ${staticResponse.status}`);
                
                if (!staticResponse.ok) {
                    staticError = new Error(`Static route failed: ${staticResponse.status} ${staticResponse.statusText}`);
                    throw staticError;
                }
                
                const staticCsvText = await staticResponse.text();
                console.log(`Received static CSV data (first 100 chars): ${staticCsvText.substring(0, 100)}`);
                parseCSV(staticCsvText);
                return; // Success, exit function
            } catch (error) {
                console.error('Error fetching CSV from static path:', error);
                staticError = error;
            }
            
            // Try hardcoded data route as final network attempt
            let hardcodedError = null;
            console.log(`Trying hardcoded CSV path: ${hardcodedPath}`);
            try {
                const hardcodedResponse = await fetch(hardcodedPath);
                console.log(`Hardcoded CSV fetch status: ${hardcodedResponse.status}`);
                
                if (!hardcodedResponse.ok) {
                    hardcodedError = new Error(`Hardcoded route failed: ${hardcodedResponse.status} ${hardcodedResponse.statusText}`);
                    throw hardcodedError;
                }
                
                const hardcodedCsvText = await hardcodedResponse.text();
                console.log(`Received hardcoded CSV data (first 100 chars): ${hardcodedCsvText.substring(0, 100)}`);
                parseCSV(hardcodedCsvText);
                return; // Success, exit function
            } catch (error) {
                console.error('Error fetching CSV from hardcoded path:', error);
                hardcodedError = error;
            }
            
            // Final fallback: Use hardcoded data function
            console.log('All network routes failed, using hardcoded data function');
            try {
                loadHardcodedFields();
                console.log('Successfully loaded hardcoded fields');
                return;
            } catch (inlineError) {
                console.error('Even hardcoded fields function failed:', inlineError);
                // At this point, we're out of options
                showCSVError(primaryError, directError, staticError, hardcodedError);
            }
        } catch (error) {
            console.error('Fatal error in loadSearchFields:', error);
            showCSVError(new Error('Fatal error: ' + error.message));
        }
    }
    
    // Function to process the CSV data 
    function parseCSV(csvText) {
        if (!csvText || csvText.trim() === '') {
            console.error('Received empty CSV text');
            throw new Error('Received empty CSV file');
        }
        
        console.log(`CSV text received, length: ${csvText.length}`);
        console.log(`CSV text preview: ${csvText.slice(0, 300)}`);
        
        const rows = csvText.split('\n');
        console.log(`Number of rows parsed: ${rows.length}`);
        
        if (rows.length < 2) {
            console.error('CSV has insufficient rows');
            throw new Error('CSV format error: insufficient rows');
        }
        
        const headers = rows[0].split(',');
        console.log('CSV headers:', headers);
        
        // Look for expected column names with different possible variations
        let propertyIndex = headers.indexOf('property');
        if (propertyIndex === -1) propertyIndex = headers.indexOf('Data Property');
        
        let displayNameIndex = headers.indexOf('displayName');
        if (displayNameIndex === -1) displayNameIndex = headers.indexOf('Display Name');
        
        let descriptionIndex = headers.indexOf('description');
        if (descriptionIndex === -1) descriptionIndex = headers.indexOf('Description');
        
        let typeIndex = headers.indexOf('type');
        if (typeIndex === -1) typeIndex = headers.indexOf('Type');
        
        let includeIndex = headers.indexOf('include?');
        if (includeIndex === -1) includeIndex = headers.indexOf('Include');

        console.log('Column indexes -', 
            'Property:', propertyIndex, 
            'Description:', descriptionIndex,
            'Type:', typeIndex,
            'Display Name:', displayNameIndex,
            'Include:', includeIndex
        );

        if (propertyIndex === -1 || descriptionIndex === -1 || typeIndex === -1 || displayNameIndex === -1) {
            console.error('CSV headers are incorrect or missing. Required headers: property/Data Property, description/Description, type/Type, displayName/Display Name');
            throw new Error('CSV format error: missing required headers');
        }

        // Clear existing search fields
        searchFields = [];
        
        // Process each row and build the searchFields array
        for (let i = 1; i < rows.length; i++) {
            const row = rows[i].trim();
            if (!row) {
                console.log(`Skipping empty row ${i + 1}`);
                continue;
            }
            
            const columns = row.split(',');
            
            if (columns.length < Math.max(propertyIndex, descriptionIndex, typeIndex, displayNameIndex) + 1) {
                console.warn(`Row ${i + 1} has insufficient columns:`, columns);
                continue;
            }
            
            // Check if this field should be included
            let include = true;
            if (includeIndex !== -1) {
                const includeValue = columns[includeIndex].trim().toLowerCase();
                include = (includeValue === '1' || includeValue === 'yes' || includeValue === 'true');
            }
            
            if (!include) {
                console.log(`Skipping field: ${columns[displayNameIndex]} (include flag is not set)`);
                continue;
            }
            
            const field = {
                property: columns[propertyIndex].trim(),
                description: columns[descriptionIndex].trim(),
                type: columns[typeIndex].trim(),
                displayName: columns[displayNameIndex].trim()
            };
            
            // Only add fields that have at least a property and display name
            if (field.property && field.displayName) {
                searchFields.push(field);
                console.log(`Adding field: ${field.displayName} (${field.property})`);
            } else {
                console.warn(`Skipping invalid field at row ${i+1}:`, field);
            }
        }

        console.log(`Loaded ${searchFields.length} search fields`);
        if (searchFields.length === 0) {
            console.warn('No fields were loaded from the CSV. Check that some rows have include flag set');
        }

        // Populate boolean search dropdowns with these fields
        populateBooleanFields();
        console.log('===== CSV LOADING SUCCESSFUL =====');
    }
    
    // Function to display CSV loading errors
    function showCSVError(primaryError, directError, staticError, hardcodedError) {
        // Try to display a user-friendly error message
        const errorMessageElement = document.getElementById('csv-error-message');
        if (errorMessageElement) {
            errorMessageElement.textContent = `Failed to load search fields: ${primaryError.message}`;
            errorMessageElement.classList.remove('d-none');
        } else {
            // If no dedicated error element exists, create one
            const errorDiv = document.createElement('div');
            errorDiv.id = 'csv-error-message';
            errorDiv.className = 'alert alert-danger';
            errorDiv.innerHTML = `
                <h5>Failed to load search fields:</h5>
                <p><strong>Primary route error:</strong> ${primaryError.message}</p>
                ${directError ? `<p><strong>Direct route error:</strong> ${directError.message}</p>` : ''}
                ${staticError ? `<p><strong>Static route error:</strong> ${staticError.message}</p>` : ''}
                ${hardcodedError ? `<p><strong>Hardcoded route error:</strong> ${hardcodedError.message}</p>` : ''}
                <p><strong>Please check:</strong></p>
                <ol>
                    <li>Server logs for detailed error information</li>
                    <li>Absolute path in config.py: <code>r'B:\WindsurfProjects\patent_database\Search_Fields_with_Query_Syntax.csv'</code></li>
                    <li>File exists at that location with read permissions</li>
                </ol>
            `;
            document.getElementById('searchForm').prepend(errorDiv);
        }
        
        // Show a direct alert for easier visibility during debugging
        alert(`CSV load error: All routes failed.\n- Primary: ${primaryError.message}\n${directError ? `- Direct: ${directError.message}\n` : ''}${staticError ? `- Static: ${staticError.message}\n` : ''}${hardcodedError ? `- Hardcoded: ${hardcodedError.message}\n` : ''}Check server logs for details.`);
        
        // Add fallback data for development/debugging
        searchFields = [
            { property: 'inventionTitle', displayName: 'Title', description: 'Title of invention', type: 'String' },
            { property: 'applicationNumberText', displayName: 'Application #', description: 'Application number', type: 'String' },
            { property: 'firstInventorName', displayName: 'First Inventor', description: 'Name of first inventor', type: 'String' }
        ];
        console.log('Using fallback field data for development');
        populateBooleanFields();
    }
    
    // Update populateBooleanFields to use displayName
    function populateBooleanFields() {
        const booleanFieldSelects = document.querySelectorAll('.boolean-field');

        booleanFieldSelects.forEach(select => {
            // Clear existing options
            select.innerHTML = '';

            // Add "No Field" option
            const noFieldOption = document.createElement('option');
            noFieldOption.value = "";
            noFieldOption.textContent = "-- No Field --";
            noFieldOption.dataset.description = "Search without a specific field. The value will be used as a raw search term.";
            select.appendChild(noFieldOption);

            // Add options from searchFields
            searchFields.forEach(field => {
                const option = document.createElement('option');
                option.value = `applicationMetaData.${field.property}`;
                option.textContent = field.displayName; // Use displayName for dropdown
                option.dataset.description = field.description;
                option.dataset.type = field.type;
                select.appendChild(option);
            });

            // Update the description for the initially selected field
            updateFieldDescription(select);
        });
    }
    
    // Function to update field description when a field is selected (with more compact display)
    function updateFieldDescription(selectElement) {
        const selectedOption = selectElement.options[selectElement.selectedIndex];
        const descriptionElement = selectElement.closest('.boolean-term').querySelector('.field-description');
        
        if (descriptionElement && selectedOption) {
            // Truncate description if it's too long to save vertical space
            let desc = selectedOption.dataset.description || '';
            if (desc.length > 100) {
                desc = desc.substring(0, 97) + '...';
            }
            descriptionElement.textContent = desc;
        }
    }
    
    // Function to add a new boolean term with reduced vertical space
    function addBooleanTerm() {
        const booleanTerms = document.getElementById('booleanTerms');
        const newTerm = document.createElement('div');
        newTerm.className = 'boolean-term row mb-2';
        
        newTerm.innerHTML = `
            <div class="col-md-2">
                <label class="form-label small">Operator</label>
                <select class="form-select boolean-operator">
                    <option value="AND">AND</option>
                    <option value="OR">OR</option>
                    <option value="NOT">NOT</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label small">Field</label>
                <select class="form-select boolean-field"></select>
                <small class="form-text text-muted field-description"></small>
            </div>
            <div class="col-md-5">
                <label class="form-label small">Value</label>
                <input type="text" class="form-control boolean-value" placeholder="Enter search value">
            </div>
            <div class="col-md-1 d-flex align-items-center">
                <button type="button" class="btn btn-outline-danger btn-sm remove-term">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `;

        booleanTerms.appendChild(newTerm);

        // Populate the field dropdown
        const fieldSelect = newTerm.querySelector('.boolean-field');
        searchFields.forEach(field => {
            const option = document.createElement('option');
            option.value = `applicationMetaData.${field.property}`;
            option.textContent = field.displayName;
            option.dataset.description = field.description;
            option.dataset.type = field.type;
            fieldSelect.appendChild(option);
        });

        // Update the description for the selected field
        updateFieldDescription(fieldSelect);

        // Add event listener for remove button
        const removeBtn = newTerm.querySelector('.remove-term');
        if (removeBtn) {
            removeBtn.addEventListener('click', function() {
                newTerm.remove();
                updateQueryPreview();
            });
        }
    }
    
    // Update the function to match test_simple.py query construction
    function getSearchParams() {
        // Get form values
        const searchType = document.getElementById('searchType').value;
        const resultsLimit = parseInt(document.getElementById('resultsLimit').value);
        const sortField = document.getElementById('sortField').value;
        const sortOrder = document.getElementById('sortOrder').value;
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;
        const simpleSearchTerm = document.getElementById('simpleSearchTerm').value;
        const applicationType = document.getElementById('applicationType').value;

        // Create payload structure exactly like test_simple.py
        const params = {
            fields: [
                "inventionTitle",
                "applicationNumberText",
                "applicationMetaData",
                "inventorNameText"
            ],
            pagination: {
                limit: resultsLimit,
                offset: currentPage * resultsLimit
            },
            rangeFilters: [],
            sort: [
                {
                    field: sortField,
                    order: sortOrder
                }
            ]
        };

        // Only add the filters if a specific application type is selected
        if (applicationType !== 'All') {
            params.filters = [
                {
                    "name": "applicationMetaData.applicationTypeLabelName",
                    "value": [
                        applicationType
                    ]
                }
            ];
        }

        // Build query based on search type (keep it simple like test_simple.py)
        if (searchType === 'simple') {
            if (simpleSearchTerm && simpleSearchTerm.trim() !== '') {
                // Simple search - use term directly without modifications
                params.q = simpleSearchTerm.trim();
            }
        } else if (searchType === 'boolean') {
            // Handle boolean search
            const booleanTerms = document.querySelectorAll('.boolean-term');
            let booleanQueryParts = [];

            booleanTerms.forEach((term, index) => {
                const field = term.querySelector('.boolean-field')?.value || '';
                const value = term.querySelector('.boolean-value')?.value || '';

                if (value) {
                    // Format values with quotes if needed
                    const formattedValue = formatQueryValue(value);

                    if (index === 0) {
                        // First term doesn't need an operator
                        if (field) {
                            // If field is selected, use field:value format
                            booleanQueryParts.push(`${field}:${formattedValue}`);
                        } else {
                            // If no field is selected, use raw value
                            booleanQueryParts.push(`${formattedValue}`);
                        }
                    } else {
                        // Add operator for subsequent terms
                        const operator = term.querySelector('.boolean-operator')?.value || 'AND';
                        if (field) {
                            // If field is selected, use field:value format
                            booleanQueryParts.push(`${operator} ${field}:${formattedValue}`);
                        } else {
                            // If no field is selected, use raw value
                            booleanQueryParts.push(`${operator} ${formattedValue}`);
                        }
                    }
                }
            });

            if (booleanQueryParts.length > 0) {
                params.q = booleanQueryParts.join(' ');
            }
        } else if (searchType === 'field_specific') {
            // Handle field-specific search
            const field = document.getElementById('fieldSpecificField')?.value;
            const value = document.getElementById('fieldSpecificValue')?.value;

            if (field && value) {
                params.q = `${field}:${formatQueryValue(value)}`;
            }
        }

        // Add date range filter if both dates are present, exactly like test_simple.py
        if (dateFrom && dateTo) {
            params.rangeFilters.push({
                field: "applicationMetaData.filingDate",
                valueFrom: dateFrom,
                valueTo: dateTo
            });
        }

        // Log the constructed query for debugging
        console.log('Constructed query:', params.q);

        return params;
    }
    
    // Helper function to format query values
    function formatQueryValue(value) {
        value = value.trim();

        // Check if the value contains spaces and isn't already quoted
        if (value.includes(' ') && !((value.startsWith('"') && value.endsWith('"')) || 
                                   (value.startsWith("'") && value.endsWith("'")))) {
            // Add quotes for multi-word values
            return `"${value}"`;
        }

        // Return value as is if it's already quoted or is a single word
        return value;
    }

    // Update the getApiKey function to use the backend key from config.py
    function getApiKey() {
        // Get the API key from the Flask backend via the correct template variable
        return '{{ api_key }}';
        // Note: If this doesn't work, check your Flask route to ensure it's passing the API key as 'api_key'
    }

    function updateQueryPreview() {
        const params = getSearchParams();
        const queryPreview = document.getElementById('queryPreview');
        const endpointUrl = document.getElementById('endpointUrl');
        
        // Use the USPTO API URL directly
        const completeUrl = "https://api.uspto.gov/api/v1/patent/applications/search";
        
        // Update endpoint URL display
        endpointUrl.textContent = completeUrl;
        
        // Create a complete request object that includes everything we send
        const completeRequest = {
            url: completeUrl,
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-API-KEY': getApiKey()
            },
            body: params
        };
        
        // Update query preview with formatted JSON of the complete request
        queryPreview.textContent = JSON.stringify(completeRequest, null, 2);
        
        // Don't show any additional debug information in the debugOutput section
        document.getElementById('debugOutput').style.display = 'none';
    }

    function performSearch() {
        const searchParams = getSearchParams();
        const showDebugInfo = document.getElementById('showQueryPreview').checked;
        const debugOutput = document.getElementById('debugOutput');
        const queryPreview = document.getElementById('queryPreview');
        const jsonOutput = document.getElementById('jsonOutput');

        // Use the USPTO API URL directly
        const completeUrl = "https://api.uspto.gov/api/v1/patent/applications/search";
        
        // Include the API key in headers
        const apiKey = getApiKey();
        const headers = {
                'Content-Type': 'application/json'
        };
        
        // Only add the API key if it's provided
        if (apiKey) {
            headers['X-API-KEY'] = apiKey;
        }

        // If debug info is showing, update the existing preview instead of adding a new one
        if (showDebugInfo) {
            // Show the debug output area
            debugOutput.style.display = 'block';
            
            // Add a timestamp to show we're searching now
            const timestampElement = document.createElement('p');
            timestampElement.className = 'mt-2 mb-0';
            timestampElement.innerHTML = `<strong>Search initiated:</strong> ${new Date().toISOString()}`;
            debugOutput.innerHTML = ''; // Clear previous response info
            debugOutput.appendChild(timestampElement);
        }

        // Clear the JSON output
        jsonOutput.textContent = 'Searching...';

        // Log the request details
        console.log('Sending search request to:', completeUrl);
        console.log('Search parameters:', searchParams);
        
        // Make the API call
        fetch(completeUrl, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(searchParams)
        })
        .then(response => {
            if (!response.ok) {
                // If debug is enabled, show the error details
                if (showDebugInfo) {
                    const errorElement = document.createElement('p');
                    errorElement.style.color = 'red';
                    errorElement.innerHTML = `<strong>Error:</strong> HTTP ${response.status} - ${response.statusText}`;
                    debugOutput.appendChild(errorElement);
                }
                jsonOutput.textContent = `Error: HTTP ${response.status} - ${response.statusText}`;
                throw new Error(`Network response was not ok: ${response.status} ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('API response:', data);
            
            // Show response in debug area if enabled
            if (showDebugInfo) {
                const responseElement = document.createElement('p');
                responseElement.innerHTML = `<strong>Response received:</strong> ${data.count || 0} results`;
                debugOutput.appendChild(responseElement);
                
                // Create a collapsible section for the response
                const responseId = `response-${Date.now()}`;
                const toggleButton = document.createElement('button');
                toggleButton.className = 'btn btn-sm btn-outline-secondary';
                toggleButton.type = 'button';
                toggleButton.textContent = 'Toggle Response Details';
                toggleButton.onclick = function() {
                    document.getElementById(responseId).classList.toggle('d-none');
                };
                
                const responseDetails = document.createElement('div');
                responseDetails.id = responseId;
                responseDetails.className = 'mt-2 d-none';
                responseDetails.innerHTML = `<pre class="bg-light p-2 rounded" style="max-height: 400px; overflow: auto;">${JSON.stringify(data, null, 2)}</pre>`;
                
                debugOutput.appendChild(toggleButton);
                debugOutput.appendChild(responseDetails);
            }
            
            // Update the JSON output
            jsonOutput.textContent = JSON.stringify(data, null, 2);
            
            // Reset pagination and store results
            currentPage = 0;
            
            // Process the results - handle different response formats
            if ((data.results && data.results.length > 0) || 
                (data.patentFileWrapperDataBag && data.patentFileWrapperDataBag.length > 0) ||
                (data.data && data.data.patentFileWrapperDataBag && data.data.patentFileWrapperDataBag.length > 0)) {
                
                // Extract results - handle both direct API response and wrapped response from our backend
                if (data.patentFileWrapperDataBag) {
                    // Direct API response format
                    currentSearchResults = data.patentFileWrapperDataBag;
                    totalResults = data.count || data.patentFileWrapperDataBag.length;
                } else if (data.data && data.data.patentFileWrapperDataBag) {
                    // Our backend might wrap the response in a data object
                    currentSearchResults = data.data.patentFileWrapperDataBag;
                    totalResults = data.data.count || data.data.metadata?.total || data.data.patentFileWrapperDataBag.length;
                } else if (data.results) {
                    // New format
                    currentSearchResults = data.results;
                    totalResults = data.count || data.results.length;
                }
                
                // Update display
                updateResultsDisplay();
                
                // Clear any table filters
                const tableSearchFilter = document.getElementById('tableSearchFilter');
                if (tableSearchFilter) {
                    tableSearchFilter.value = '';
                }
                
                // Scroll to results
                document.getElementById('resultsContainer').scrollIntoView({ behavior: 'smooth' });
                
                // Collapse the search parameters card after successful search
                collapseSearchCard();
                
                // Log success
                const successMsg = `Search completed successfully. Found ${totalResults} results.`;
                console.log(successMsg);
                
                if (showDebugInfo) {
                    const successElement = document.createElement('p');
                    successElement.style.color = 'green';
                    successElement.innerHTML = `<strong>Success:</strong> ${successMsg}`;
                    debugOutput.appendChild(successElement);
                }
            } else {
                // No results found
                currentSearchResults = [];
                totalResults = 0;
                
                // Show "No results" message in both views
                document.getElementById('resultsList').innerHTML = `
                    <div class="alert alert-warning">
                        No results found. Please try different search parameters.
                    </div>
                `;
                
                document.getElementById('resultsTableBody').innerHTML = `
                    <tr>
                        <td colspan="11" class="text-center py-3">
                            <div class="alert alert-warning mb-0">
                                No results found. Please try different search parameters.
                            </div>
                        </td>
                    </tr>
                `;
                
                // Update result count
                document.getElementById('resultCount').textContent = '0';
                
                // Show the container anyway to display the no results message
                document.getElementById('resultsContainer').classList.remove('d-none');
                
                console.log('No results found');
                
                if (showDebugInfo) {
                    const infoElement = document.createElement('p');
                    infoElement.innerHTML = `<strong>Info:</strong> No results found for the search query.`;
                    debugOutput.appendChild(infoElement);
                }
            }
        })
        .catch(error => {
            console.error('Error performing search:', error);
            alert('Error performing search: ' + error.message);
            jsonOutput.textContent = `Error: ${error.message}`;
            
            if (showDebugInfo) {
                const errorElement = document.createElement('p');
                errorElement.style.color = 'red';
                errorElement.innerHTML = `<strong>Error:</strong> ${error.message}`;
                debugOutput.appendChild(errorElement);
            }
        });
    }

    function updateResultsDisplay() {
        const resultsList = document.getElementById('resultsList');
        const resultsTableBody = document.getElementById('resultsTableBody');
        const resultCount = document.getElementById('resultCount');
        const paginationInfo = document.getElementById('paginationInfo');
        const showDetails = document.getElementById('showDetailsToggle') ? document.getElementById('showDetailsToggle').checked : true;
        
        // Update result count
        resultCount.textContent = totalResults;
        
        // Clear existing results
        resultsList.innerHTML = '';
        resultsTableBody.innerHTML = '';
        
        // Calculate pagination
        const start = currentPage * pageSize;
        const end = Math.min(start + pageSize, currentSearchResults.length);
        
        // Update pagination info
        paginationInfo.textContent = `Showing ${start + 1}-${end} of ${totalResults}`;
        
        // Display results
        const resultsToShow = currentSearchResults.slice(start, end);
        
        // Populate both views (table and cards)
        resultsToShow.forEach((result, index) => {
            // Extract data from the nested structure
            const metadata = result.applicationMetaData || {};
            const title = metadata.inventionTitle || 'No Title';
            const applicationNumber = result.applicationNumberText || 'N/A';
            const filingDate = metadata.filingDate || 'N/A';
            
            // Handle inventors from the inventor bag
            let inventors = 'N/A';
            let inventorsHtml = '';
            if (metadata.inventorBag && metadata.inventorBag.length > 0) {
                // Create HTML with first inventor bold
                inventorsHtml = metadata.inventorBag
                    .map((inventor, index) => {
                        const name = inventor.inventorNameText || '';
                        return index === 0 ? `<strong>${name}</strong>` : name;
                    })
                    .filter(Boolean)
                    .join(', ');
                
                // Create plain text for fallback
                inventors = metadata.inventorBag
                    .map(inventor => inventor.inventorNameText)
                    .filter(Boolean)
                    .join(', ');
            } else if (metadata.firstInventorName) {
                inventorsHtml = `<strong>${metadata.firstInventorName}</strong>`;
                inventors = metadata.firstInventorName;
            }
            
            // Get applicant information
            let applicant = 'N/A';
            if (metadata.applicantBag && metadata.applicantBag.length > 0) {
                applicant = metadata.applicantBag[0].applicantNameText;
            } else if (metadata.firstApplicantName) {
                applicant = metadata.firstApplicantName;
            }
            
            // Get the additional requested fields
            const publicationDate = metadata.earliestPublicationDate || 'N/A';
            const applicationType = metadata.applicationTypeLabelName || 'N/A';
            const examiner = metadata.examinerNameText || 'N/A';
            const publicationNumber = metadata.earliestPublicationNumber || 'N/A';
            const customerNumber = metadata.customerNumber || 'N/A';
            const applicationStatus = metadata.applicationStatusDescriptionText || 'N/A';
            
            // Create publication URL if available
            let publicationUrl = '';
            if (publicationNumber !== 'N/A') {
                publicationUrl = `https://ppubs.uspto.gov/pubwebapp/external.html?q=${publicationNumber}`;
            }
            
            // 1. Create table row for table view
            const tableRow = document.createElement('tr');
            tableRow.dataset.patentIndex = index;
            tableRow.dataset.title = title;
            tableRow.dataset.filingDate = filingDate;
            tableRow.dataset.applicant = applicant;
            tableRow.dataset.publicationNumber = publicationNumber;
            tableRow.dataset.status = applicationStatus;
            tableRow.dataset.type = applicationType;
            tableRow.dataset.customerNumber = customerNumber;
            tableRow.dataset.examiner = examiner;
            tableRow.dataset.inventors = inventors;
            tableRow.dataset.applicationNumber = applicationNumber;
            
            tableRow.innerHTML = `
                <td><span class="truncate-cell title-cell" title="${title}">${index + 1}. ${title.toUpperCase()}</span></td>
                <td>${filingDate}</td>
                <td><span class="truncate-cell applicant-cell" title="${applicant}">${applicant}</span></td>
                <td>${publicationNumber !== 'N/A' ? 
                        `<a href="${publicationUrl}" target="_blank" class="text-primary">${publicationNumber}</a>` : 
                        publicationNumber}</td>
                <td>${applicationStatus}</td>
                <td>${applicationType}</td>
                <td>${customerNumber}</td>
                <td>${examiner}</td>
                <td><span class="truncate-cell cell-lg" title="${inventors}">${inventors}</span></td>
                <td>${applicationNumber}</td>
                <td>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle btn-action" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-three-dots"></i>
                        </button>
                        <ul class="dropdown-menu action-dropdown">
                            <li><a class="dropdown-item view-details-btn" href="#" data-index="${index}"><i class="bi bi-eye me-2"></i>View Details</a></li>
                            <li><a class="dropdown-item" href="${publicationUrl}" target="_blank"><i class="bi bi-box-arrow-up-right me-2"></i>Open USPTO</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item copy-data-btn" href="#" data-field="title"><i class="bi bi-clipboard me-2"></i>Copy Title</a></li>
                            <li><a class="dropdown-item copy-data-btn" href="#" data-field="applicationNumber"><i class="bi bi-clipboard me-2"></i>Copy App #</a></li>
                        </ul>
                    </div>
                </td>
            `;
            
            resultsTableBody.appendChild(tableRow);
            
            // 2. Create card item for card view (original display)
            const resultItem = document.createElement('div');
            resultItem.className = 'list-group-item py-0 patent-result';
            resultItem.dataset.patentIndex = index;
            
            // Basic information with enumerated title, chevron, and compact layout
            let content = 
                `<div class="d-flex align-items-start">
                    <button class="btn btn-sm toggle-details-btn me-2" aria-expanded="${showDetails ? 'true' : 'false'}">
                        <i class="bi ${showDetails ? 'bi-chevron-down' : 'bi-chevron-right'}"></i>
                    </button>
                    <div class="flex-grow-1">
                        <div class="patent-title-container">
                            <h5 class="patent-title m-0">${index + 1}. ${title.toUpperCase()}</h5>
                        </div>
                        <div class="compact-info d-flex flex-wrap">
                            <span class="me-3"><strong>Filed:</strong> ${filingDate}</span>
                            <span class="me-3"><strong>Applicant:</strong> ${applicant}</span>
                            <span class="me-3"><strong>Pub #:</strong> ${publicationNumber !== 'N/A' ? 
                                `<a href="${publicationUrl}" target="_blank" class="text-primary">${publicationNumber}</a>` : 
                                publicationNumber}</span>
                            <span><strong>Status:</strong> ${applicationStatus}</span>
                        </div>
                        <div class="patent-details ${showDetails ? '' : 'd-none'}">
                            <div class="detail-row">
                                <span class="me-3"><strong>App #:</strong> ${applicationNumber}</span>
                                <span class="me-3"><strong>Publication Date:</strong> ${publicationDate}</span>
                                <span class="me-3"><strong>Type:</strong> ${applicationType}</span>
                                <span class="me-3"><strong>Customer #:</strong> ${customerNumber}</span>
                                <span><strong>Examiner:</strong> ${examiner}</span>
                            </div>
                            <div class="detail-row">
                                <span><strong>Inventors:</strong> ${inventorsHtml || inventors}</span>
                            </div>
                        </div>
                    </div>
                </div>`;
            
            resultItem.innerHTML = content;
            resultsList.appendChild(resultItem);
            
            // Add event listener for the chevron toggle button
            const toggleBtn = resultItem.querySelector('.toggle-details-btn');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', function() {
                    const expanded = this.getAttribute('aria-expanded') === 'true';
                    this.setAttribute('aria-expanded', !expanded);
                    this.querySelector('i').className = expanded ? 'bi bi-chevron-right' : 'bi bi-chevron-down';
                    resultItem.querySelector('.patent-details').classList.toggle('d-none', expanded);
                });
            }
        });

        // Call updatePagination after displaying results
        updatePagination();
    }

    // Final fallback function with hardcoded data
    function loadHardcodedFields() {
        console.log('Loading hardcoded search fields as absolute last fallback');
        searchFields = [
            { property: 'inventionTitle', displayName: 'Title', description: 'Title of invention', type: 'String' },
            { property: 'assigneeEntityName', displayName: 'Assignee', description: 'Patent assignee/owner', type: 'String' },
            { property: 'firstNamedInventor', displayName: 'First Inventor', description: 'Name of first inventor', type: 'String' },
            { property: 'applicationNumberText', displayName: 'Application #', description: 'Application number', type: 'String' },
            { property: 'publicationNumber', displayName: 'Publication #', description: 'Publication number', type: 'String' },
            { property: 'grantDate', displayName: 'Grant Date', description: 'Date patent was granted', type: 'Date' },
            { property: 'publicationDate', displayName: 'Publication Date', description: 'Date patent was published', type: 'Date' },
            { property: 'filingDate', displayName: 'Filing Date', description: 'Date application was filed', type: 'Date' },
            { property: 'abstractText', displayName: 'Abstract', description: 'Abstract text of patent', type: 'String' },
            { property: 'patentApplicationType', displayName: 'App Type', description: 'Type of patent application', type: 'String' }
        ];
        console.log(`Loaded ${searchFields.length} hardcoded search fields`);
        populateBooleanFields();
    }

    // Table sorting functionality
    function setupTableSorting() {
        const tableHeaders = document.querySelectorAll('#resultsTable th.sortable');
        tableHeaders.forEach(header => {
            header.addEventListener('click', function() {
                const sortField = this.getAttribute('data-sort');
                let sortDirection = 'asc';
                
                // If already sorted, toggle direction
                if (this.classList.contains('sort-asc')) {
                    sortDirection = 'desc';
                    this.classList.remove('sort-asc');
                    this.classList.add('sort-desc');
                } else if (this.classList.contains('sort-desc')) {
                    sortDirection = 'asc';
                    this.classList.remove('sort-desc');
                    this.classList.add('sort-asc');
                } else {
                    // First time sorting this column
                    // Clear other sort indicators
                    tableHeaders.forEach(h => {
                        h.classList.remove('sort-asc', 'sort-desc', 'active-sort');
                    });
                    this.classList.add('sort-asc', 'active-sort');
                }
                
                // Sort the data
                sortTableData(sortField, sortDirection);
            });
        });
    }
    
    // Sort the table data
    function sortTableData(field, direction) {
        const tbody = document.getElementById('resultsTableBody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        // Sort the rows
        rows.sort((a, b) => {
            let aValue = a.dataset[field] || '';
            let bValue = b.dataset[field] || '';
            
            // Handle different data types
            if (field === 'filingDate' || field === 'publicationDate') {
                // Date comparison
                const aDate = new Date(aValue);
                const bDate = new Date(bValue);
                return direction === 'asc' ? 
                    (aDate - bDate) : 
                    (bDate - aDate);
            } else if (field === 'customerNumber') {
                // Numeric comparison
                const aNum = parseInt(aValue) || 0;
                const bNum = parseInt(bValue) || 0;
                return direction === 'asc' ? 
                    (aNum - bNum) : 
                    (bNum - aNum);
            } else {
                // String comparison
                return direction === 'asc' ? 
                    aValue.localeCompare(bValue) : 
                    bValue.localeCompare(aValue);
            }
        });
        
        // Re-append in sorted order
        rows.forEach(row => tbody.appendChild(row));
    }
    
    // Setup table filtering
    function setupTableFilter() {
        const filterInput = document.getElementById('tableSearchFilter');
        if (filterInput) {
            filterInput.addEventListener('input', function() {
                const filterValue = this.value.toLowerCase().trim();
                filterTableResults(filterValue);
            });
        }
    }
    
    // Filter table results
    function filterTableResults(filterValue) {
        const rows = document.querySelectorAll('#resultsTableBody tr');
        
        rows.forEach(row => {
            // Reset highlights
            row.querySelectorAll('.highlight-match').forEach(el => {
                el.classList.remove('highlight-match');
            });
            
            if (!filterValue) {
                row.style.display = '';
                return;
            }
            
            let found = false;
            const cellsToSearch = row.querySelectorAll('td');
            
            cellsToSearch.forEach(cell => {
                const cellText = cell.textContent.toLowerCase();
                if (cellText.includes(filterValue)) {
                    found = true;
                    // Highlight match if it's in a span
                    const spans = cell.querySelectorAll('span');
                    if (spans.length > 0) {
                        spans.forEach(span => {
                            if (span.textContent.toLowerCase().includes(filterValue)) {
                                span.classList.add('highlight-match');
                            }
                        });
                    }
                }
            });
            
            row.style.display = found ? '' : 'none';
        });
        
        // Update the count of visible rows
        updateFilteredCount();
    }
    
    // Update the count of filtered results
    function updateFilteredCount() {
        const visibleRows = document.querySelectorAll('#resultsTableBody tr:not([style*="display: none"])').length;
        const totalRows = document.querySelectorAll('#resultsTableBody tr').length;
        const resultCount = document.getElementById('resultCount');
        
        if (visibleRows < totalRows) {
            resultCount.textContent = `${visibleRows} of ${totalRows}`;
        } else {
            resultCount.textContent = totalRows;
        }
    }
    
    // Setup view toggle between table and card views
    function setupViewToggle() {
        const tableViewBtn = document.getElementById('tableViewBtn');
        const cardViewBtn = document.getElementById('cardViewBtn');
        const tableResultsView = document.getElementById('tableResultsView');
        const cardResultsView = document.getElementById('cardResultsView');
        
        if (tableViewBtn && cardViewBtn) {
            tableViewBtn.addEventListener('click', function() {
                tableResultsView.classList.remove('d-none');
                cardResultsView.classList.add('d-none');
                tableViewBtn.classList.add('active');
                cardViewBtn.classList.remove('active');
            });
            
            cardViewBtn.addEventListener('click', function() {
                tableResultsView.classList.add('d-none');
                cardResultsView.classList.remove('d-none');
                tableViewBtn.classList.remove('active');
                cardViewBtn.classList.add('active');
            });
        }
    }
    
    // Add code for the "view details" button in the table
    document.addEventListener('click', function(e) {
        if (e.target && e.target.closest('.view-details-btn')) {
            e.preventDefault();
            const button = e.target.closest('.view-details-btn');
            const index = button.getAttribute('data-index');
            const result = currentSearchResults[index];
            
            // Here you could show a modal with details or expand a row
            console.log('View details for result', result);
            // TODO: Implement detail view
        }
        
        if (e.target && e.target.closest('.copy-data-btn')) {
            e.preventDefault();
            const button = e.target.closest('.copy-data-btn');
            const field = button.getAttribute('data-field');
            const row = button.closest('tr');
            const value = row.dataset[field];
            
            // Copy to clipboard
            navigator.clipboard.writeText(value).then(() => {
                // Show success notification
                const originalText = button.textContent;
                button.innerHTML = '<i class="bi bi-check me-2"></i>Copied!';
                setTimeout(() => {
                    button.innerHTML = originalText;
                }, 2000);
            });
        }
    });
    
    // Add additional pagination functionality to update both views
    function updatePagination() {
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        
        // Calculate page bounds
        const start = currentPage * pageSize;
        const end = Math.min(start + pageSize, totalResults);
        
        // Update pagination buttons
        prevPageBtn.disabled = currentPage === 0;
        nextPageBtn.disabled = end >= totalResults;
        
        // Show the results container
        document.getElementById('resultsContainer').classList.remove('d-none');
    }

    // Add column filtering functionality
    function setupColumnFiltering() {
        // Create a dropdown for filtering
        const filterDropdown = document.createElement('div');
        filterDropdown.id = 'columnFilterDropdown';
        filterDropdown.className = 'column-filter-dropdown';
        filterDropdown.innerHTML = `
            <div class="dropdown-header">
                <strong>Filter by <span id="filterColumnName"></span></strong>
                <button type="button" class="btn btn-sm btn-close" id="closeFilterDropdown"></button>
            </div>
            <input type="text" class="filter-search" id="filterSearch" placeholder="Search values...">
            <div class="filter-items" id="filterItems"></div>
            <div class="filter-actions">
                <button type="button" class="btn btn-sm btn-outline-primary" id="selectAllValues">Select All</button>
                <button type="button" class="btn btn-sm btn-outline-primary" id="clearAllValues">Clear All</button>
                <button type="button" class="btn btn-sm btn-primary" id="applyFilter">Apply Filter</button>
            </div>
        `;
        document.body.appendChild(filterDropdown);
        
        // Store active filters for each column
        const columnFilters = {};
        
        // Add click event to filterable column headers
        const filterableHeaders = document.querySelectorAll('.filterable');
        filterableHeaders.forEach(header => {
            const filterIcon = header.querySelector('.filter-icon');
            if (filterIcon) {
                filterIcon.addEventListener('click', function(e) {
                    e.stopPropagation(); // Don't trigger sorting when clicking filter icon
                    showFilterDropdown(header);
                });
            }
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.column-filter-dropdown') && !e.target.closest('.filter-icon')) {
                filterDropdown.classList.remove('show');
            }
        });
        
        // Close dropdown button
        document.getElementById('closeFilterDropdown').addEventListener('click', function() {
            filterDropdown.classList.remove('show');
        });
        
        // Filter search functionality
        document.getElementById('filterSearch').addEventListener('input', function() {
            const searchText = this.value.toLowerCase();
            const items = document.querySelectorAll('#filterItems .filter-item');
            items.forEach(item => {
                const value = item.textContent.toLowerCase();
                item.style.display = value.includes(searchText) ? '' : 'none';
            });
        });
        
        // Select all values
        document.getElementById('selectAllValues').addEventListener('click', function() {
            const items = document.querySelectorAll('#filterItems .filter-item input[type="checkbox"]');
            items.forEach(item => {
                item.checked = true;
            });
        });
        
        // Clear all values
        document.getElementById('clearAllValues').addEventListener('click', function() {
            const items = document.querySelectorAll('#filterItems .filter-item input[type="checkbox"]');
            items.forEach(item => {
                item.checked = false;
            });
        });
        
        // Apply filter
        document.getElementById('applyFilter').addEventListener('click', function() {
            const columnName = document.getElementById('filterColumnName').dataset.field;
            const checkedValues = [];
            
            // Get all checked values
            const checkboxes = document.querySelectorAll('#filterItems .filter-item input[type="checkbox"]:checked');
            checkboxes.forEach(checkbox => {
                checkedValues.push(checkbox.value);
            });
            
            // Update the column filters
            if (checkedValues.length === 0 || checkedValues.length === document.querySelectorAll('#filterItems .filter-item').length) {
                // If all or none are selected, remove the filter
                delete columnFilters[columnName];
                document.querySelector(`th[data-field="${columnName}"] .filter-badge`).classList.add('d-none');
            } else {
                // Otherwise, apply the filter
                columnFilters[columnName] = checkedValues;
                document.querySelector(`th[data-field="${columnName}"] .filter-badge`).classList.remove('d-none');
            }
            
            // Apply all filters
            applyColumnFilters();
            
            // Hide the dropdown
            filterDropdown.classList.remove('show');
        });
        
        // Function to show the filter dropdown for a specific column
        function showFilterDropdown(header) {
            const columnName = header.textContent.split(' ')[0];
            const field = header.dataset.field;
            const rect = header.getBoundingClientRect();
            const dropdown = document.getElementById('columnFilterDropdown');
            
            // Position the dropdown
            dropdown.style.top = (rect.bottom + window.scrollY) + 'px';
            dropdown.style.left = (rect.left + window.scrollX) + 'px';
            
            // Set the column name
            const filterColumnName = document.getElementById('filterColumnName');
            filterColumnName.textContent = columnName;
            filterColumnName.dataset.field = field;
            
            // Clear any previous search
            document.getElementById('filterSearch').value = '';
            
            // Populate unique values
            populateUniqueValues(field);
            
            // Show the dropdown
            dropdown.classList.add('show');
        }
        
        // Function to populate unique values for a column
        function populateUniqueValues(field) {
            const filterItems = document.getElementById('filterItems');
            filterItems.innerHTML = '';
            
            // Get unique values from the table
            const uniqueValues = getUniqueColumnValues(field);
            
            // Sort the values
            uniqueValues.sort((a, b) => {
                if (a === 'N/A') return 1; // Place N/A at the end
                if (b === 'N/A') return -1;
                return a.localeCompare(b);
            });
            
            // Create checkboxes for each value
            uniqueValues.forEach(value => {
                const item = document.createElement('div');
                item.className = 'filter-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `filter-${field}-${value.replace(/[^a-zA-Z0-9]/g, '')}`;
                checkbox.value = value;
                checkbox.className = 'form-check-input me-2';
                
                // Check if the value is in the current filter
                if (columnFilters[field]) {
                    checkbox.checked = columnFilters[field].includes(value);
                } else {
                    checkbox.checked = true; // By default all are checked
                }
                
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.className = 'form-check-label';
                label.textContent = value;
                
                item.appendChild(checkbox);
                item.appendChild(label);
                filterItems.appendChild(item);
            });
        }
        
        // Function to get unique values for a column
        function getUniqueColumnValues(field) {
            const values = new Set();
            const rows = document.querySelectorAll('#resultsTableBody tr');
            
            rows.forEach(row => {
                let value = row.dataset[field] || 'N/A';
                values.add(value);
            });
            
            return Array.from(values);
        }
        
        // Function to apply all column filters
        function applyColumnFilters() {
            const rows = document.querySelectorAll('#resultsTableBody tr');
            
            rows.forEach(row => {
                let visible = true;
                
                // Check each active filter
                for (const [field, allowedValues] of Object.entries(columnFilters)) {
                    const value = row.dataset[field] || 'N/A';
                    if (!allowedValues.includes(value)) {
                        visible = false;
                        break;
                    }
                }
                
                row.style.display = visible ? '' : 'none';
            });
            
            // Update the count of visible rows
            updateFilteredCount();
        }
    }

    // Function to setup collapsible search parameters card
    function setupCollapsibleCard() {
        const searchParametersHeader = document.getElementById('searchParametersHeader');
        const cardBody = searchParametersHeader.closest('.card').querySelector('.card-body');
        const toggleIcon = searchParametersHeader.querySelector('.toggle-icon');
        
        // Add click event listener to the header
        searchParametersHeader.addEventListener('click', function() {
            // Toggle card body visibility
            cardBody.classList.toggle('d-none');
            
            // Toggle icon direction
            toggleIcon.classList.toggle('collapsed');
        });
    }

    // Function to collapse the search parameters card
    function collapseSearchCard() {
        const searchParametersHeader = document.getElementById('searchParametersHeader');
        const cardBody = searchParametersHeader.closest('.card').querySelector('.card-body');
        const toggleIcon = searchParametersHeader.querySelector('.toggle-icon');
        
        // Only collapse if it's not already collapsed
        if (!cardBody.classList.contains('d-none')) {
            cardBody.classList.add('d-none');
            toggleIcon.classList.add('collapsed');
        }
    }
</script>
{% endblock %}
